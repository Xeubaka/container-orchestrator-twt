events {
  worker_connections 1024;
}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  sendfile        on;
  keepalive_timeout 65;

  # Compressão gzip para respostas JSON e estáticos
  gzip on;
  gzip_types text/plain application/json application/javascript text/css;
  gzip_min_length 1000;

  upstream backend {
    server backend:3000;
  }

  upstream frontend {
    server frontend:3001;
  }

  server {
    listen 80;
    server_name _;

    # ── Arquivos de upload (imagens de perfil e posts) ─────────────────────────
    location /uploads/ {
      proxy_pass         http://backend;
      proxy_http_version 1.1;
      proxy_set_header   Host              $host;
      proxy_set_header   X-Real-IP         $remote_addr;

      # Cache de imagens por 7 dias
      proxy_cache_valid  200 7d;
      add_header         Cache-Control "public, max-age=604800";
    }

    # ── API REST (NestJS) ──────────────────────────────────────────────────────
    # Prefixo /api/* é stripped antes de encaminhar ao backend
    # Exemplo: /api/auth/login → http://backend:3000/auth/login
    location /api/ {
      rewrite ^/api/(.*) /$1 break;

      proxy_pass         http://backend;
      proxy_http_version 1.1;
      proxy_set_header   Host              $host;
      proxy_set_header   X-Real-IP         $remote_addr;
      proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header   X-Forwarded-Proto $scheme;

      # Timeout generoso para operações longas (inclui upload de arquivos)
      proxy_read_timeout 60s;
      client_max_body_size 10m;
    }

    # ── Next.js: arquivos estáticos (cache agressivo) ──────────────────────────
    location /_next/static/ {
      proxy_pass         http://frontend;
      proxy_http_version 1.1;
      proxy_set_header   Host $host;

      # Estáticos do Next.js têm hash no nome: cache de 1 ano
      add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # ── Next.js: tudo mais (SSR, Server Actions, páginas) ─────────────────────
    location / {
      proxy_pass         http://frontend;
      proxy_http_version 1.1;

      # Suporte a Server-Sent Events e WebSockets (HMR em dev)
      proxy_set_header   Upgrade           $http_upgrade;
      proxy_set_header   Connection        "upgrade";
      proxy_set_header   Host              $host;
      proxy_set_header   X-Real-IP         $remote_addr;
      proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header   X-Forwarded-Proto $scheme;

      proxy_read_timeout 60s;
      client_max_body_size 10m;
    }
  }
}
